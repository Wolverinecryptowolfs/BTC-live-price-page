<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live BTC Price and Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@latest/dist/chartjs-plugin-crosshair.min.js"></script>
    <style>
        /* Custom style for centering content vertically and horizontally */
        body {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            align-items: center; /* Center items horizontally */
            min-height: 100vh;
            background-color: #ffffff; /* White background */
            color: #1a202c; /* Dark text for readability on white */
            font-family: 'Inter', sans-serif; /* Use Inter font */
            padding: 0; /* Remove default body padding */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* Style for the navigation bar */
        nav {
            width: 100%; /* Full width */
            background-color: #2d3748; /* Dark gray background */
            padding: 0.75rem 20px; /* Reduced padding top/bottom and sides */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            display: flex;
            justify-content: center; /* Center navigation links */
            flex-wrap: wrap; /* Allow links to wrap on smaller screens */
            gap: 20px; /* Space between nav links */
        }

        nav a {
            color: #e2e8f0; /* Light gray text */
            text-decoration: none; /* No underline */
            font-weight: bold;
            font-size: 1rem;
            transition: color 0.2s ease-in-out;
        }

        nav a:hover {
            color: #34d399; /* Green on hover */
        }

        .container {
            text-align: center;
            width: 100%; /* Make container take full width */
            max-width: 800px; /* Limit max width for better readability on large screens */
            margin-bottom: 20px; /* Add space below the main price section */
            padding: 20px; /* Add padding to the main content container */
        }

        /* Style for positive percentage change and amount */
        .text-green-500 {
            color: #10b981; /* Adjusted green for better contrast on white */
        }

        /* Style for negative percentage change and amount */
        .text-red-500 {
            color: #ef4444;
        }

        /* Style for the currency select dropdown */
        #currency-select,
        .converter-select {
            background-color: #e2e8f0; /* Light gray background for contrast */
            color: #1a202c; /* Dark text */
            border: 1px solid #718096; /* Darker gray border */
            border-radius: 0.25rem; /* Rounded corners */
            padding: 0.5rem;
            font-size: 1rem;
        }

         #currency-select {
             margin-bottom: 1rem; /* Add margin below the main currency select */
         }


        /* Style for the chart container */
        #chart-container {
            width: 100%;
            max-width: 800px; /* Limit max width for better readability on large screens */
            margin: 20px auto; /* Center the chart and add margin */
            background-color: #f7fafc; /* Light background for chart area */
            border-radius: 0.5rem; /* Rounded corners for chart container */
            padding: 15px; /* Padding inside chart container */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

         /* Media query to remove max-width on smaller screens */
         @media (max-width: 768px) { /* Adjust breakpoint as needed */
             #chart-container {
                 max-width: none; /* Remove max-width on smaller screens */
                 padding: 10px; /* Adjust padding for smaller screens */
             }
         }


         /* Ensure canvas is responsive and control height on mobile */
        #btcChart {
            width: 100% !important;
            height: auto !important;
        }

         /* Media query to set max-height on smaller screens */
         @media (max-width: 768px) {
             #btcChart {
                 max-height: 1600px; /* Increased maximum height for the chart on mobile */
             }
         }


        /* Style for time range buttons */
        .time-range-buttons {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            gap: 10px; /* Space between buttons */
        }

        .time-range-button {
            padding: 8px 12px;
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.25rem;
            background-color: #f3f4f6; /* Very light gray background */
            color: #1f2937; /* Dark gray text */
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
        }

        .time-range-button:hover {
            background-color: #e5e7eb; /* Slightly darker gray on hover */
        }

        .time-range-button.active {
            background-color: #3b82f6; /* Blue background for active button */
            color: #ffffff; /* White text for active button */
            border-color: #3b82f6;
        }

        /* Style for the currency converter section */
        .currency-converter {
            margin-top: 30px; /* Add space above the converter */
            padding: 20px;
            background-color: #f7fafc; /* Light background */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px; /* Limit converter width */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .converter-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%; /* Make input group take full width */
        }

        .converter-input-group input[type="number"],
        .converter-input-group input[type="text"] { /* Include text type for styling */
            flex-grow: 1; /* Allow input to take available space */
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: #ffffff;
            color: #1a202c;
            font-size: 1rem;
        }

         .converter-input-group input[type="number"]:focus,
         .converter-input-group input[type="text"]:focus { /* Include text type for styling */
             outline: none;
             border-color: #3b82f6; /* Highlight on focus */
             box-shadow: 0 0 0 1px #3b82f6;
         }

        .converter-select {
             flex-shrink: 0; /* Prevent select from shrinking */
        }

         .converter-equals {
             font-size: 1.5rem;
             font-weight: bold;
             margin: 10px 0;
         }

         /* Style for the footer */
         footer {
             margin-top: 40px; /* Space above the footer */
             padding-top: 20px;
             border-top: 1px solid #e2e8f0; /* Light line above footer */
             width: 100%;
             text-align: center;
             color: #4a5568; /* Gray text for footer */
             font-size: 0.9rem;
         }

         footer a {
             color: #3b82f6; /* Blue links */
             text-decoration: none; /* No underline by default */
             margin: 0 10px; /* Space between links */
         }

         footer a:hover {
             text-decoration: underline; /* Underline on hover */
         }

         footer p {
             margin-top: 10px; /* Space above the copyright */
             margin-bottom: 0; /* Remove default bottom margin */
         }

        /* Style for the donation section */
        .donation-section {
            margin-top: 30px; /* Space above the donation section */
            padding: 20px;
            background-color: #e2e8f0; /* Light gray background */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px; /* Match converter width */
            text-align: center;
        }

        .donation-section h2 {
            color: #2d3748; /* Dark gray heading */
            margin-bottom: 10px;
        }

        .donation-section p {
            margin-bottom: 15px;
            color: #4a5568; /* Gray text */
        }

        .donation-section .wallet-address {
            font-weight: bold;
            color: #1a202c; /* Dark text for address */
            word-break: break-all; /* Break long addresses */
        }

        /* Style for the merchandise section */
        .merch-section {
            margin-top: 40px; /* Space above the merch section */
            padding: 20px;
            background-color: #f7fafc; /* Light background */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px; /* Match container width */
            text-align: center;
        }

        .merch-section h2 {
            color: #2d3748; /* Dark gray heading */
            margin-bottom: 20px;
        }

        .merch-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px; /* Space between merch items */
        }

        .merch-item {
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 150px; /* Fixed width for demo items */
            text-align: center;
        }

        .merch-item img {
            max-width: 100%;
            height: auto;
            border-radius: 0.25rem;
            margin-bottom: 10px;
        }

        .merch-item h3 {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #1a202c;
        }

        .merch-item p {
            font-size: 0.9rem;
            color: #4a5568;
        }

         .merch-section .view-shop-button {
             display: inline-block; /* Make the link a block element for padding/margin */
             margin-top: 20px; /* Space above the button */
             padding: 10px 20px;
             background-color: #3b82f6; /* Blue button */
             color: #ffffff; /* White text */
             border-radius: 0.25rem;
             text-decoration: none;
             font-weight: bold;
             transition: background-color 0.2s ease-in-out;
         }

         .merch-section .view-shop-button:hover {
             background-color: #2563eb; /* Darker blue on hover */
         }


    </style>
</head>
<body class="bg-white text-gray-900 font-sans">

    <nav>
        <a href="#price-chart">Price & Chart</a>
        <a href="#converter">Converter</a>
        <a href="#merch-section">Merch</a>
        <a href="#donation-section">Support Us</a>
        <a href="#what-is-bitcoin">What is Bitcoin?</a>
        <a href="#how-to-buy-btc">How to Buy BTC</a>
        <a href="#btc-news">BTC News</a>
        <a href="#contact">Contact</a>
    </nav>

    <div class="container" id="price-chart">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg" alt="Bitcoin Logo" class="mx-auto h-24 w-24 mb-4">

        <h1 class="text-2xl md:text-3xl font-bold mb-4 text-gray-900">Current Bitcoin (BTC) Price</h1>

        <select id="currency-select" class="mb-4">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="JPY">JPY</option>
            <option value="CAD">CAD</option>
            <option value="AUD">AUD</option>
            <option value="CHF">CHF</option>
            <option value="CNY">CNY</n>
            <option value="INR">INR</option>
            <option value="BRL">BRL</option>
            </select>

        <div id="btc-price" class="text-6xl md:text-8xl lg:text-9xl font-extrabold text-green-500 mb-2">
            Loading...
        </div>
        <div id="btc-change" class="text-xl md:text-2xl font-semibold">
            Loading change...
        </div>
        <p class="mt-4 text-sm text-gray-600">Price and 24h change updates every 30 seconds (via CryptoCompare API)</p>
    </div>

    <div class="time-range-buttons">
        <button class="time-range-button" data-range="1H">1H</button> <button class="time-range-button" data-range="4H">4H</button> <button class="time-range-button active" data-range="1D">1D</button>
        <button class="time-range-button" data-range="7D">7D</button>
        <button class="time-range-button" data-range="1M">1M</button>
        <button class="time-range-button" data-range="6M">6M</button>
        <button class="time-range-button" data-range="1Y">1Y</button>
        <button class="time-range-button" data-range="ALL">ALL</button>
    </div>

    <div id="chart-container">
        <canvas id="btcChart"></canvas>
    </div>

    <div class="currency-converter" id="converter">
        <h2 class="text-xl font-bold mb-4 text-gray-900">Currency Converter</h2>
        <div class="converter-input-group">
            <input type="number" id="amount1" value="1" min="0">
            <select id="currency1" class="converter-select">
                <option value="BTC">BTC</option>
                 </select>
        </div>
         <div class="converter-equals">=</div>
        <div class="converter-input-group">
            <input type="text" id="amount2" value="">
            <select id="currency2" class="converter-select">
                 </select>
        </div>
    </div>

    <div class="donation-section" id="donation-section">
        <h2 class="text-xl font-bold">Support Us</h2>
        <p>If you find this free service helpful and would like to support its operation, consider making a small donation. Your contribution helps keep the site running and free for everyone.</p>
        <p>Solana Wallet Address:</p>
        <p class="wallet-address">HNFyj7SnT4wHNyuARgMRbBC9DSUcD5fRAcDXtdhARd6P</p>
    </div>

    <div class="merch-section" id="merch-section">
        <h2 class="text-xl font-bold">BTC Merchandise</h2>
        <p>Show your support for Bitcoin with our exclusive merchandise!</p>
        <div class="merch-items">
            <div class="merch-item">
                <img src="https://placehold.co/100x100/e2e8f0/1a202c?text=BTC+Shirt" alt="BTC Shirt Placeholder">
                <h3>BTC T-Shirt</h3>
                <p>$25.00</p>
            </div>
            <div class="merch-item">
                <img src="https://placehold.co/100x100/e2e8f0/1a202c?text=BTC+Mug" alt="BTC Mug Placeholder">
                <h3>BTC Mug</h3>
                <p>$15.00</p>
            </div>
            <div class="merch-item">
                <img src="https://placehold.co/100x100/e2e8f0/1a202c?text=BTC+Sticker" alt="BTC Sticker Placeholder">
                <h3>BTC Sticker Pack</h3>
                <p>$5.00</p>
            </div>
        </div>
        <a href="#" class="view-shop-button">View Full Shop</a>
    </div>


    <footer>
        <a href="imprint.html">Imprint</a> |
        <a href="privacy.html">Privacy Policy</a>
        <p>&copy; 2025 btc-price.com</p>
    </footer>


    <script>
        // Mapping of currency codes to symbols for display
        const currencySymbols = {
            USD: '$',
            EUR: '€',
            GBP: '£',
            JPY: '¥',
            CAD: '$',
            AUD: '$',
            CHF: 'CHF ', // CHF symbol often placed before the amount
            CNY: '¥',
            INR: '₹',
            BRL: 'R$',
            BTC: '₿', // Symbol for Bitcoin
            // Add more currency symbols as needed
        };

         // List of supported fiat currencies (matching the main currency select)
         const fiatCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'CNY', 'INR', 'BRL'];


        let btcChartInstance = null; // Variable to hold the chart instance
        let selectedTimeRange = '1D'; // Default selected time range
        let currentBtcPriceInSelectedFiat = 0; // Variable to store the current BTC price in the selected fiat currency


         // Populate currency dropdowns in the converter
         function populateConverterCurrencies() {
             const currency1Select = document.getElementById('currency1');
             const currency2Select = document.getElementById('currency2');

             // Clear existing options (except for BTC in currency1)
             currency1Select.innerHTML = '<option value="BTC">BTC</option>';
             currency2Select.innerHTML = '';


             // Add fiat currencies to both dropdowns
             fiatCurrencies.forEach(currency => {
                 const option1 = document.createElement('option');
                 option1.value = currency;
                 option1.textContent = currency;
                 currency1Select.appendChild(option1); // Add fiat currencies to the first dropdown

                 const option2 = document.createElement('option');
                 option2.value = currency;
                 option2.textContent = currency;
                 currency2Select.appendChild(option2);
             });

              // Add BTC to the second dropdown
             const btcOption2 = document.createElement('option');
             btcOption2.value = 'BTC';
             btcOption2.textContent = 'BTC';
             currency2Select.appendChild(btcOption2);

             // Set default selections
             currency1Select.value = 'BTC';
             // Set currency2 to the initially selected fiat currency from the main dropdown
             const mainCurrencySelect = document.getElementById('currency-select');
             currency2Select.value = mainCurrencySelect.value;
         }


        // Function to perform currency conversion
        function performConversion(event) {
            const amount1Input = document.getElementById('amount1');
            const amount2Input = document.getElementById('amount2');
            const currency1Select = document.getElementById('currency1');
            const currency2Select = document.getElementById('currency2');

            const currency1 = currency1Select.value;
            const currency2 = currency2Select.value;

            let inputAmount;
            let outputInput;
            let inputCurrency;
            let outputCurrency;

            // Determine which input triggered the conversion
            if (event && event.target.id === 'amount1') {
                inputAmount = parseFloat(amount1Input.value);
                outputInput = amount2Input;
                inputCurrency = currency1;
                outputCurrency = currency2;
            } else if (event && event.target.id === 'amount2') {
                 // Remove currency symbol and commas before parsing for amount2
                 const cleanedAmount2 = amount2Input.value.replace(/[^0-9.-]/g, '');
                 inputAmount = parseFloat(cleanedAmount2);
                 outputInput = amount1Input;
                 inputCurrency = currency2;
                 outputCurrency = currency1;
            } else {
                 // If no event (e.g., called on initial load or currency change)
                 // Default to converting from amount1
                 inputAmount = parseFloat(amount1Input.value);
                 outputInput = amount2Input;
                 inputCurrency = currency1;
                 outputCurrency = currency2;
            }


            if (isNaN(inputAmount)) {
                outputInput.value = '';
                return;
            }

            let convertedAmount = 0;

            // Conversion logic based on current BTC price in the selected fiat currency
            if (currentBtcPriceInSelectedFiat > 0) {
                if (inputCurrency === 'BTC' && fiatCurrencies.includes(outputCurrency)) {
                    // BTC to Fiat
                    convertedAmount = inputAmount * currentBtcPriceInSelectedFiat;
                } else if (fiatCurrencies.includes(inputCurrency) && outputCurrency === 'BTC') {
                    // Fiat to BTC
                     // Assuming the input fiat currency is the same as the main selected fiat for simplicity
                     if (inputCurrency === document.getElementById('currency-select').value) {
                         convertedAmount = inputAmount / currentBtcPriceInSelectedFiat;
                     } else {
                          outputInput.value = "Unsupported Fiat to BTC";
                          console.warn("Unsupported Fiat to BTC conversion for different fiat than main selection.");
                          return;
                     }
                } else if (fiatCurrencies.includes(inputCurrency) && fiatCurrencies.includes(outputCurrency)) {
                    // Fiat to Fiat (requires intermediate step via BTC or direct fiat rates)
                     console.warn("Fiat-to-Fiat conversion via BTC might not be perfectly accurate without direct fiat exchange rates.");
                     // For now, indicate this is not directly supported with the current setup.
                     outputInput.value = "Fiat-to-Fiat N/A";
                     return;

                } else if (inputCurrency === outputCurrency) {
                    // Same currency conversion
                    convertedAmount = inputAmount;
                } else {
                     outputInput.value = "Unsupported Conversion"; // Unsupported conversion
                     console.warn("Unsupported conversion type.");
                     return;
                }

                // Format the converted amount
                 const formattedConvertedAmount = convertedAmount.toLocaleString('en-US', {
                     minimumFractionDigits: outputCurrency === 'BTC' ? 8 : 2, // More digits for BTC
                     maximumFractionDigits: outputCurrency === 'BTC' ? 8 : 2,
                 });

                // Get the symbol for the output currency and prepend it if it's a text input
                 const outputCurrencySymbol = currencySymbols[outputCurrency] || '';
                 if (outputInput.type === 'text') {
                     outputInput.value = `${outputCurrencySymbol}${formattedConvertedAmount}`;
                 } else {
                      // If the output is a number input (like amount1), just set the number
                      outputInput.value = convertedAmount;
                 }


            } else {
                outputInput.value = "Loading price..."; // Price not loaded yet
            }
        }


        // Function to fetch and display the BTC price and 24h change for the selected currency
        async function fetchBtcPriceAndChange() {
            const priceElement = document.getElementById('btc-price');
            const changeElement = document.getElementById('btc-change');
            const currencySelect = document.getElementById('currency-select');
            const selectedCurrency = currencySelect.value;
            const currencySymbol = currencySymbols[selectedCurrency] || ''; // Get symbol or use empty string

            // Using CryptoCompare API endpoint for multiple symbols full data
            // fsyms=BTC is the base cryptocurrency
            // tsyms=${selectedCurrency} is the target fiat currency
            const apiUrl = `https://min-api.cryptocompare.com/data/pricemultifull?fsyms=BTC&tsyms=${selectedCurrency}`;

            try {
                // Fetch data from the CryptoCompare API
                const response = await fetch(apiUrl);

                // Check if the request was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Parse the JSON response
                const data = await response.json();

                // Check if data is available for BTC and the selected currency
                // CryptoCompare nests data under 'RAW' and then the symbols
                if (!data.RAW || !data.RAW.BTC || !data.RAW.BTC[selectedCurrency]) {
                     throw new Error(`Could not retrieve data for BTC in ${selectedCurrency}`);
                }

                // Extract the latest price, 24h price change amount, and 24h price change percentage
                const btcData = data.RAW.BTC[selectedCurrency];
                const btcPrice = btcData.PRICE;
                const priceChange = btcData.CHANGE24HOUR;
                const priceChangePercent = btcData.CHANGEPCT24HOUR;

                // Store the fetched price for the converter
                currentBtcPriceInSelectedFiat = btcPrice;


                // Format the price with the correct currency symbol
                const formattedPrice = `${currencySymbol}${btcPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Format the percentage change
                const formattedChangePercent = `${priceChangePercent !== undefined ? priceChangePercent.toFixed(2) : 'N/A'}%`;

                // Format the price change amount with the correct currency symbol and handle the sign
                 const formattedChangeAmount = priceChange !== undefined ?
                    `${priceChange >= 0 ? '+' : ''}${currencySymbol}${Math.abs(priceChange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` :
                    'N/A';


                // Combine the formatted change percentage and amount, adding "24h"
                const combinedChangeText = `24h: ${formattedChangePercent} (${formattedChangeAmount})`;

                // Update the content of the price element
                priceElement.textContent = formattedPrice;

                // Update the content and color of the change element based on the percentage (if available)
                changeElement.textContent = combinedChangeText;
                changeElement.classList.remove('text-green-500', 'text-red-500'); // Remove existing color classes

                if (priceChangePercent !== undefined) {
                    if (priceChangePercent >= 0) {
                        changeElement.classList.add('text-green-500'); // Green for positive or zero change
                    } else {
                        changeElement.classList.add('text-red-500'); // Red for negative change
                    }
                } else {
                     // If change data is not available, potentially set a default color or no color
                     // For now, we'll leave it as the default text color
                }


                // Ensure price text color is green if it was previously red due to an error
                 if (priceElement.classList.contains('text-red-500')) {
                    priceElement.classList.remove('text-red-500');
                    priceElement.classList.add('text-green-500'); // Changed to green-500 for better contrast on white
                }

                // Perform conversion after fetching the latest price
                performConversion();


            } catch (error) {
                // Log any errors and display an error message
                console.error("Error fetching BTC price and change:", error);
                priceElement.textContent = "Error loading price";
                changeElement.textContent = "Error loading change";
                 // Change text color to red on error for both elements
                priceElement.classList.remove('text-green-500'); // Changed from green-400
                priceElement.classList.add('text-red-500');
                changeElement.classList.remove('text-green-500');
                changeElement.classList.add('text-red-500');

                 // Also update converter to show error
                 document.getElementById('amount2').value = "Error";
                 currentBtcPriceInSelectedFiat = 0; // Reset price on error
                 performConversion(); // Attempt conversion with 0 price (will show loading/error)
            }
        }

        // Function to fetch and render the chart based on the selected time range
        async function fetchAndRenderChart() {
            const currencySelect = document.getElementById('currency-select');
            const selectedCurrency = currencySelect.value;
            const chartCanvas = document.getElementById('btcChart');
            const chartContext = chartCanvas.getContext('2d');

            // Destroy existing chart instance if it exists
            if (btcChartInstance) {
                btcChartInstance.destroy();
            }

            let apiUrl = '';
            let timeUnit = '';
            let labelFormat = {};
            let chartTitle = `BTC Price (${selectedCurrency})`;
            let limit = 0; // Initialize limit


            // Determine API endpoint, limit, and time unit based on selected time range
            switch (selectedTimeRange) {
                case '1H': // Added 1 Hour case
                    apiUrl = `https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=${selectedCurrency}`;
                    limit = 60; // 60 minutes for 1 hour
                    timeUnit = 'minute';
                    labelFormat = { hour: '2-digit', minute: '2-digit', hour12: true };
                    chartTitle = `BTC Price (${selectedCurrency}) - Last 1 Hour (Minute Data)`;
                    break;
                case '4H': // Added 4 Hour case
                    apiUrl = `https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=${selectedCurrency}`;
                    limit = 240; // 240 minutes for 4 hours (4 * 60)
                    timeUnit = 'minute';
                    labelFormat = { hour: '2-digit', minute: '2-digit', hour12: true };
                    chartTitle = `BTC Price (${selectedCurrency}) - Last 4 Hours (Minute Data)`;
                    break;
                case '1D':
                    // Fetch minute data for the last 24 hours (1440 minutes)
                    apiUrl = `https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=${selectedCurrency}`;
                    limit = 1440; // Fetch exactly 1440 data points for 24 hours
                    timeUnit = 'minute';
                     // Include hour12: true for AM/PM format
                     labelFormat = { hour: '2-digit', minute: '2-digit', hour12: true };
                     chartTitle = `BTC Price (${selectedCurrency}) - Last 24 Hours (Minute Data)`;
                    break;
                case '7D':
                    // Fetch hourly data for the last 7 days (168 hours)
                    apiUrl = `https://min-api.cryptocompare.com/data/v2/histohour?fsym=BTC&tsym=${selectedCurrency}`;
                    limit = 168; // Fetch exactly 168 data points for 7 days
                    timeUnit = 'hour';
                     // Include hour12: true for AM/PM format and day
                     labelFormat = { hour: '2-digit', minute: '2-digit', day: 'numeric', hour12: true };
                     chartTitle = `BTC Price (${selectedCurrency}) - Last 7 Days (Hourly Data)`;
                    break;
                case '1M':
                    // Fetch hourly data for the last 30 days (approx 720 hours)
                     apiUrl = `https://min-api.cryptocompare.com/data/v2/histohour?fsym=BTC&tsym=${selectedCurrency}`;
                     limit = 720; // Fetch approximately 30 days of hourly data
                    timeUnit = 'hour'; // Changed to hourly data
                     // Include hour12: true for AM/PM format, day, and month for hourly data over a month
                     labelFormat = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
                     chartTitle = `BTC Price (${selectedCurrency}) - Last 1 Month (Hourly Data)`; // Updated title
                    break;
                 case '6M':
                    // Fetch daily data for the last 180 days (approx 6 months)
                     apiUrl = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=${selectedCurrency}`;
                     limit = 180; // Fetch approximately 6 months of daily data
                    timeUnit = 'day';
                     labelFormat = { month: 'short', day: 'numeric', year: 'numeric' };
                     chartTitle = `BTC Price (${selectedCurrency}) - Last 6 Months (Daily Data)`;
                    break;
                 case '1Y':
                    // Fetch daily data for the last 365 days (approx 1 year)
                     apiUrl = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=${selectedCurrency}`;
                     limit = 365; // Fetch approximately 1 year of daily data
                    timeUnit = 'day';
                     labelFormat = { month: 'short', day: 'numeric', year: 'numeric' };
                     chartTitle = `BTC Price (${selectedCurrency}) - Last 1 Year (Daily Data)`;
                    break;
                case 'ALL':
                    // Fetch daily data for a large limit (CryptoCompare API limit is 2000 for histoday)
                    apiUrl = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=${selectedCurrency}`;
                    limit = 2000; // Use the maximum allowed limit for histoday
                    timeUnit = 'day';
                     labelFormat = { month: 'short', day: 'numeric', year: 'numeric' };
                     chartTitle = `BTC Price (${selectedCurrency}) - All Time (Daily Data)`;
                    break;
                default:
                    // Default to 1 Day if something goes wrong
                    apiUrl = `https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=${selectedCurrency}`;
                    limit = 1440;
                    timeUnit = 'minute';
                     labelFormat = { hour: '2-digit', minute: '2-digit', hour12: true };
                     chartTitle = `BTC Price (${selectedCurrency}) - Last 24 Hours (Minute Data)`;
            }

            // Append the limit parameter to the API URL
            apiUrl += `&limit=${limit}`;


            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Check if data is available
                if (!data.Data || !data.Data.Data || data.Data.Data.length === 0) {
                     // If no data for the specific range, try fetching 1D as a fallback
                     if (selectedTimeRange !== '1D') {
                         console.warn(`No data for ${selectedTimeRange}, attempting to load 1D data.`);
                         selectedTimeRange = '1D'; // Set range to 1D
                         // Update active button visually
                         document.querySelectorAll('.time-range-button').forEach(button => {
                             button.classList.remove('active');
                             if (button.dataset.range === '1D') {
                                 button.classList.add('active');
                             }
                         });
                         fetchAndRenderChart(); // Call recursively for 1D
                         return; // Exit current call
                     } else {
                         throw new Error(`No historical data available for BTC in ${selectedCurrency} for 1D`);
                     }
                }

                // Process the historical data
                const chartLabels = [];
                const chartData = [];

                data.Data.Data.forEach(hourData => {
                    const date = new Date(hourData.time * 1000); // Convert seconds to milliseconds

                    // Log raw timestamp and created Date object during data processing
                    // console.log("Processing Data - Raw Timestamp:", hourData.time);
                    // console.log("Processing Data - Date object:", date);
                    // console.log("Processing Data - Date object getTime():", date.getTime());


                     if (timeUnit === 'minute' || timeUnit === 'hour') {
                         chartLabels.push(date.toLocaleTimeString('en-US', labelFormat)); // Format time for minute/hourly data in English
                     } else {
                         chartLabels.push(date.toLocaleDateString('en-US', labelFormat)); // Format date for daily/longer in English
                     }
                    chartData.push(hourData.close);
                });

                // Create the chart
                btcChartInstance = new Chart(chartContext, {
                    type: 'line', // Line chart for price over time
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: chartTitle, // Use the dynamic chart title
                            data: chartData,
                            borderColor: '#34d399', // Green color for the line
                            backgroundColor: 'rgba(52, 211, 153, 0.2)', // Light green fill below the line
                            tension: 0.1, // Slightly curved line
                            pointRadius: 0, // Hide data points
                            fill: true, // Fill area below the line
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Allow chart to resize freely
                         plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#1a202c' // Dark text for legend
                                }
                            },
                            tooltip: { // Enable and configure tooltips
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        // Add currency symbol and formatted value
                                        const value = context.parsed.y; // Get the y-value (price)
                                        const currency = document.getElementById('currency-select').value;
                                        const symbol = currencySymbols[currency] || '';
                                         // Format the value with appropriate decimal places
                                        const formattedValue = value.toLocaleString('en-US', {
                                            minimumFractionDigits: currency === 'BTC' ? 8 : 2, // More digits for BTC
                                            maximumFractionDigits: currency === 'BTC' ? 8 : 2,
                                        });
                                        label += `${symbol}${formattedValue}`;
                                        return label;
                                    },
                                    title: function(context) {
                                        // Display the time/date as the tooltip title
                                        // Use the timestamp from the original data point, not parsed.x
                                        // This is a potential fix if parsed.x is not the original timestamp
                                        const dataIndex = context[0].dataIndex;
                                        const originalTimestamp = data.Data.Data[dataIndex].time; // Access original timestamp
                                        const date = new Date(originalTimestamp * 1000); // Convert seconds to milliseconds


                                        // Log timestamp and date object for debugging
                                        // console.log("Tooltip Timestamp (from original data):", originalTimestamp);
                                        // console.log("Tooltip Date object (from original data):", date);
                                        // console.log("Tooltip Date object getTime():", date.getTime());
                                        // console.log("Tooltip Date object getHours():", date.getHours());
                                        // console.log("Tooltip Date object getMinutes():", date.getMinutes());


                                         if (timeUnit === 'minute' || timeUnit === 'hour') {
                                             // Explicitly use hour12: true for AM/PM format
                                             const options = { hour: '2-digit', minute: '2-digit', hour12: true };
                                              if (timeUnit === 'hour') { // Add day for hourly data (7D, 1M)
                                                 options.day = 'numeric';
                                                 // Add month for 1M hourly data
                                                  if (selectedTimeRange === '1M') {
                                                     options.month = 'short';
                                                  }
                                              }
                                              const formattedTime = date.toLocaleTimeString('en-US', options);
                                              // console.log("Formatted Time (toLocaleTimeString):", formattedTime);

                                              // Manual formatting for comparison
                                              const hours = date.getHours();
                                              const minutes = date.getMinutes();
                                              const ampm = hours >= 12 ? 'PM' : 'AM';
                                              const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
                                              const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                                              const manualTime = `${formattedHours}:${formattedMinutes} ${ampm}`;
                                              // console.log("Formatted Time (Manual):", manualTime);


                                             return formattedTime;
                                         } else {
                                             const formattedDate = date.toLocaleDateString('en-US', labelFormat);
                                             // console.log("Formatted Date (toLocaleDateDateString):", formattedDate);
                                             return formattedDate;
                                         }
                                    }
                                }
                            },
                             // Configure the crosshair plugin
                            crosshair: {
                                line: {
                                    color: '#718096', // Color of the crosshair line (gray)
                                    width: 1 // Width of the crosshair line
                                },
                                sync: {
                                    enabled: false // Disable syncing with other charts if any
                                },
                                zoom: {
                                    enabled: false // Disable zooming with crosshair
                                }
                            }
                        },
                         // Moved hover configuration into interaction
                        interaction: {
                            mode: 'index',
                            intersect: false,
                            axis: 'x' // Draw a vertical line along the x-axis
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: timeUnit === 'minute' || timeUnit === 'hour' ? 'Time' : 'Date', // Update x-axis title based on time unit
                                     color: '#1a202c' // Dark text for x-axis title
                                },
                                ticks: {
                                    color: '#4a5568', // Gray text for x-axis ticks
                                     maxRotation: 45, // Rotate labels up to 45 degrees
                                     minRotation: 45, // Ensure labels are rotated by at least 45 degrees
                                     autoSkip: true, // Allow Chart.js to automatically skip ticks
                                     // Adjust maxTicksLimit for minute/hourly data to show fewer labels
                                     maxTicksLimit: timeUnit === 'minute' ? 8 : (timeUnit === 'hour' ? 12 : 10) // Adjusted limits
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: `Price (${selectedCurrency})`,
                                     color: '#1a202c' // Dark text for y-axis title
                                },
                                ticks: {
                                     color: '#4a5568' // Gray text for y-axis ticks
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Error fetching historical data or rendering chart:", error);
                // Optionally display an error message in the chart area
                 if (btcChartInstance) {
                     btcChartInstance.destroy(); // Destroy any incomplete chart
                 }
                 chartContext.clearRect(0, 0, chartCanvas.width, chartCanvas.height); // Clear canvas
                 chartContext.fillStyle = '#ef4444'; // Red color for error text
                 chartContext.font = '1rem Inter, sans-serif';
                 chartContext.textAlign = 'center';
                 chartContext.fillText('Error loading chart data', chartCanvas.width / 2, chartCanvas.height / 2);
            }
        }

        // Function to explicitly set canvas size based on container
        // Removed setCanvasSize function as CSS handles responsiveness

         // --- Currency Converter Logic ---

         // Event listeners for converter inputs and selects
         document.getElementById('amount1').addEventListener('input', performConversion);
         document.getElementById('amount2').addEventListener('input', performConversion); // Add listener to the second input
         document.getElementById('currency1').addEventListener('change', performConversion);
         document.getElementById('currency2').addEventListener('change', performConversion);


        // Fetch data and render chart immediately when the page loads
        window.onload = function() {
            // Removed setCanvasSize call
            fetchBtcPriceAndChange();
            fetchAndRenderChart();
            populateConverterCurrencies(); // Populate converter dropdowns on load
        };


        // Fetch the price and change every 30 seconds
        setInterval(fetchBtcPriceAndChange, 30000);

        // Add event listener to the main currency select dropdown
        document.getElementById('currency-select').addEventListener('change', () => {
            fetchBtcPriceAndChange(); // Update price and change
            fetchAndRenderChart(); // Update chart
            // Also update the second currency in the converter to match the main selection
            document.getElementById('currency2').value = document.getElementById('currency-select').value;
            performConversion(); // Perform conversion with the new currency
        });

        // Add event listeners to the time range buttons
        document.querySelectorAll('.time-range-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove 'active' class from all buttons
                document.querySelectorAll('.time-range-button').forEach(btn => btn.classList.remove('active'));
                // Add 'active' class to the clicked button
                button.classList.add('active');
                // Update the selected time range
                selectedTimeRange = button.dataset.range;
                // Fetch and render the chart for the new time range
                fetchAndRenderChart();
            });
        });


         // Add a resize observer to make the chart responsive
         const resizeObserver = new ResizeObserver(() => {
             // Removed setCanvasSize call
             if (btcChartInstance) {
                 btcChartInstance.resize();
             }
         });

         const chartContainer = document.getElementById('chart-container');
         resizeObserver.observe(chartContainer);

    </script>

</body>
</html>
